<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeeBee AI - 약관</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="icon" type="image/png" sizes="32x21" href="/image/tabLogo.png" />
  </head>

  <body>
    <!-- 헤더 영역 -->
    <div class="header-group">
      <a href="index.html">
        <div class="header-logo-container">
          <div class="logo-image">
            <img src="image/Logo.png" alt="BeeBeeAI Logo" />
          </div>
          <div class="logo-text">BeeBee AI</div>
        </div>
      </a>
    </div>

    <!-- 이용 약관 -->
    <section class="policy-hero">
      <h1>약관 및 정책</h1>
      <p>BeeBee AI 서비스 이용에 필요한 모든 정책을 안내드립니다.</p>
    </section>

    <main class="policy-container">
      <!-- ======================= -->
      <!-- 1. 이용약관 -->
      <!-- ======================= -->
      <section class="policy-section">
        <h2>1. 이용약관</h2>
        <p>
          본 약관은 BeeBee AI(이하 “회사”)가 제공하는 자동 수식 생성 및 매크로
          생성 서비스(이하 “서비스”)의 이용조건과 운영에 관한 사항을 규정합니다.
        </p>

        <h3>1.1 서비스 제공 내용</h3>
        <ul>
          <li>엑셀/구글시트에 입력되는 수식 자동 생성 기능 제공</li>
          <li>Office Script/Google Apps Script 자동 생성 기능 제공</li>
          <li>회원 전용 기능 및 업로드 파일 기반 고급 생성 기능 제공</li>
          <li>향후 제공될 추가 기능 및 업데이트 제공</li>
        </ul>

        <h3>1.2 회원 계정</h3>
        <ul>
          <li>회원은 실제 사용 가능한 이메일 계정을 사용해야 합니다.</li>
          <li>
            타인의 이메일을 도용하는 경우 서비스 이용이 제한될 수 있습니다.
          </li>
          <li>회원은 자신의 계정을 안전하게 관리할 책임이 있습니다.</li>
        </ul>

        <h3>1.3 서비스 이용 제한</h3>
        <ul>
          <li>
            비정상적 사용(대량 자동 요청, 시스템 공격 등) 발생 시 사전 통보 없이
            이용을 제한할 수 있습니다.
          </li>
          <li>
            불법적 데이터 생성, 저작권 침해 등 위반 행위 발견 시 계정이 정지될
            수 있습니다.
          </li>
        </ul>
      </section>

      <!-- ======================= -->
      <!-- 2. 개인정보 처리방침 -->
      <!-- ======================= -->
      <section class="policy-section">
        <h2>2. 개인정보 처리방침</h2>

        <p>
          BeeBee AI는 회원 가입 및 서비스 제공에 필요한 최소한의 개인정보만을
          수집합니다.
        </p>

        <h3>2.1 수집 항목</h3>
        <ul>
          <li>이메일 주소 (계정 생성 및 로그인)</li>
          <li>비밀번호(암호화 저장)</li>
          <li>사용 로그(기능 사용 횟수, 업로드 파일 수 등)</li>
        </ul>

        <h3>2.2 개인정보 보관 및 파기</h3>
        <ul>
          <li>서비스 제공 기간 동안에만 데이터를 보관합니다.</li>
          <li>
            <a href="#" id="open-withdraw-modal">회원 탈퇴</a>시 모든 개인정보는
            즉시 삭제됩니다.
          </li>
        </ul>

        <h3>2.3 제3자 제공 여부</h3>
        <p>
          BeeBee AI는 법령에 따른 요청 외에는 개인정보를 제3자에게 제공하지
          않습니다.
        </p>
      </section>

      <!-- ======================= -->
      <!-- 3. 환불정책 -->
      <!-- ======================= -->
      <section class="policy-section">
        <h2>3. 환불정책</h2>

        <h3>3.1 정기구독 환불</h3>
        <ul>
          <li>
            결제 후 서비스 미사용 시 결제일 기준 7일 이내 전액 환불 가능합니다.
          </li>
          <li>
            서비스 사용(수식 생성, 매크로 생성 등)이 1회라도 발생한 경우 해당
            이용월은 환불이 어렵습니다.
          </li>
        </ul>

        <h3>3.2 정기결제 해지</h3>
        <ul>
          <li>
            해지는 다음 결제일 전까지 요청하면 다음 달부터 결제가 중단됩니다.
          </li>
          <li>결제 후 당월은 부분 환불되지 않습니다.</li>
        </ul>

        <h3>3.3 서비스 장애 시 보상</h3>
        <ul>
          <li>
            24시간 이상 전면 서비스 장애 발생 시 이용 기간 연장 또는 부분 환불이
            제공됩니다.
          </li>
        </ul>
      </section>

      <!-- ======================= -->
      <!-- 4. 구독정책 / 요금정책 -->
      <!-- ======================= -->
      <section class="policy-section">
        <h2>4. 구독정책</h2>
        <ul>
          <li>월 구독료: 4,900원</li>
          <li>결제 방식: 토스페이먼츠 정기구독</li>
          <li>
            <!-- <a href="#" id="open-cancel-modal">구독 해지</a
            > false 변경 시 주석 해지--><a
              href="#"
              id="open-cancel-modal"
              data-beta-lock="cancel"
              >구독 해지</a
            >는 언제든지 신청 가능합니다.
          </li>
          <li>
            이용자는 구독 기간 동안 모든 일반 기능을 자유롭게 이용할 수
            있습니다.
          </li>
        </ul>
      </section>
    </main>

    <!-- ===================================================== -->
    <!-- 구독 해지 모달 (비밀번호 제거 / 확인 버튼 방식) -->
    <!-- ===================================================== -->
    <div id="cancelModal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop" id="cancelModalBackdrop"></div>

      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="cancelModalTitle"
      >
        <h3 id="cancelModalTitle">구독 해지</h3>

        <p class="modal-desc">
          구독을 해지하면 <b>다음 결제일부터 자동 결제가 중단</b>됩니다.<br />
          이미 결제된 기간은 만료일까지 이용 가능하며, 환불은 별도 정책에
          따릅니다.
        </p>

        <div class="modal-actions">
          <button id="cancelModalClose" class="btn-secondary">취소</button>
          <button id="cancelModalSubmit" class="btn-danger">해지하기</button>
        </div>

        <p id="cancelModalMsg" class="modal-msg"></p>
      </div>
    </div>

    <!-- ===================================================== -->
    <!-- 회원 탈퇴 모달 (비밀번호 제거 / DELETE 입력 방식) -->
    <!-- ===================================================== -->
    <div id="withdrawModal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop" id="withdrawModalBackdrop"></div>

      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="withdrawModalTitle"
      >
        <h3 id="withdrawModalTitle">회원 탈퇴</h3>

        <p class="modal-desc">
          회원 탈퇴 시 <b>즉시 이용이 종료</b>되며, 계정 복구가 어렵습니다.<br />
          탈퇴 전 필요한 데이터가 있다면 먼저 저장해주세요.
        </p>

        <label class="modal-label" for="withdrawConfirmText"
          >확인 문구 입력</label
        >
        <input
          id="withdrawConfirmText"
          class="modal-input"
          type="text"
          placeholder="DELETE 를 입력하세요"
          autocomplete="off"
        />
        <p class="modal-hint">
          회원 탈퇴를 진행하려면 <b>DELETE</b>를 입력해주세요.
        </p>

        <div class="modal-actions">
          <button id="withdrawModalClose" class="btn-secondary">취소</button>
          <button id="withdrawModalSubmit" class="btn-danger">탈퇴하기</button>
        </div>

        <p id="withdrawModalMsg" class="modal-msg"></p>
      </div>
    </div>

    <script>
      // =========================
      // API
      // =========================
      const API_BASE = "https://beebeeai-backend-production.up.railway.app";

      const getToken = () => localStorage.getItem("token");

      async function apiFetch(path, { method = "GET", body } = {}) {
        const token = getToken();
        const r = await fetch(`${API_BASE}${path}`, {
          method,
          headers: {
            "content-type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: body ? JSON.stringify(body) : undefined,
          credentials: "include",
        });
        const data = await r.json().catch(() => ({}));
        return { r, data };
      }

      function fmtKST(d) {
        if (!d) return "";
        try {
          return new Date(d).toLocaleString("ko-KR", {
            timeZone: "Asia/Seoul",
          });
        } catch {
          return String(d);
        }
      }

      // =========================
      // 구독 해지 모달
      // =========================
      const cModal = document.getElementById("cancelModal");
      const cOpen = document.getElementById("open-cancel-modal");
      const cClose = document.getElementById("cancelModalClose");
      const cBackdrop = document.getElementById("cancelModalBackdrop");
      const cSubmit = document.getElementById("cancelModalSubmit");
      const cMsg = document.getElementById("cancelModalMsg");

      function openCancel() {
        cMsg.textContent = "";
        cMsg.classList.remove("error", "success");
        cModal.classList.remove("hidden");
        cModal.setAttribute("aria-hidden", "false");
      }
      function closeCancel() {
        cModal.classList.add("hidden");
        cModal.setAttribute("aria-hidden", "true");
      }

      cOpen?.addEventListener("click", (e) => {
        e.preventDefault();
        openCancel();
      });
      cClose?.addEventListener("click", closeCancel);
      cBackdrop?.addEventListener("click", closeCancel);

      // =========================
      // 회원 탈퇴 모달
      // =========================
      const wModal = document.getElementById("withdrawModal");
      const wOpen = document.getElementById("open-withdraw-modal");
      const wClose = document.getElementById("withdrawModalClose");
      const wBackdrop = document.getElementById("withdrawModalBackdrop");
      const wSubmit = document.getElementById("withdrawModalSubmit");
      const wInput = document.getElementById("withdrawConfirmText");
      const wMsg = document.getElementById("withdrawModalMsg");

      function openWithdraw() {
        wMsg.textContent = "";
        wMsg.classList.remove("error", "success");
        wInput.value = "";
        wModal.classList.remove("hidden");
        wModal.setAttribute("aria-hidden", "false");
        setTimeout(() => wInput.focus(), 50);
      }
      function closeWithdraw() {
        wModal.classList.add("hidden");
        wModal.setAttribute("aria-hidden", "true");
      }

      wOpen?.addEventListener("click", (e) => {
        e.preventDefault();
        openWithdraw();
      });
      wClose?.addEventListener("click", closeWithdraw);
      wBackdrop?.addEventListener("click", closeWithdraw);

      // ESC 닫기
      window.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        if (!cModal.classList.contains("hidden")) closeCancel();
        if (!wModal.classList.contains("hidden")) closeWithdraw();
      });

      // =========================
      // 구독 해지 실행
      // =========================
      cSubmit?.addEventListener("click", async () => {
        const ok = confirm(
          "정말 구독을 해지하시겠습니까?\n해지 후 다음 결제일부터 자동 결제가 중단됩니다."
        );
        if (!ok) return;

        cSubmit.disabled = true;
        cMsg.textContent = "처리 중…";
        cMsg.classList.remove("error", "success");

        try {
          const { r, data } = await apiFetch(
            "/api/payments/subscription/cancel",
            {
              method: "POST",
              body: {}, // 서버에서 body 필요 없도록 설계한 상태
            }
          );

          if (!r.ok) {
            if (data?.code === "NO_SUBSCRIPTION") {
              cMsg.textContent = "현재 구독 상태가 아닙니다.";
              cMsg.classList.add("success");
              cSubmit.disabled = false;
              return;
            }
            cMsg.textContent = data?.message || data?.error || "구독 해지 실패";
            cMsg.classList.add("error");
            cSubmit.disabled = false;
            return;
          }

          // 서버가 code를 내려주면 분기
          if (data?.code === "ALREADY_CANCELED") {
            cMsg.textContent = "이미 구독 해지가 완료된 상태입니다.";
            cMsg.classList.add("success");
          } else if (data?.code === "ALREADY_CANCELED_PENDING") {
            const exp = fmtKST(data?.expiresAt);
            cMsg.textContent = exp
              ? `이미 구독 해지가 접수되었습니다. 이용 만료일(${exp})까지 사용 가능합니다.`
              : "이미 구독 해지가 접수되었습니다. 이용 만료일까지 사용 가능합니다.";
            cMsg.classList.add("success");
          } else {
            const exp = fmtKST(data?.expiresAt);
            cMsg.textContent = exp
              ? `구독 해지가 접수되었습니다. 이용 만료일(${exp})까지 사용 가능합니다.`
              : "구독 해지가 접수되었습니다. 다음 결제일부터 결제가 중단됩니다.";
            cMsg.classList.add("success");
          }

          cSubmit.disabled = false;

          window.dispatchEvent(new Event("auth:changed"));
        } catch (e) {
          cMsg.textContent = "네트워크 오류가 발생했습니다.";
          cMsg.classList.add("error");
          cSubmit.disabled = false;
        }
      });

      // =========================
      // 회원 탈퇴 실행
      // =========================
      wSubmit?.addEventListener("click", async () => {
        const confirmText = String(wInput.value || "")
          .trim()
          .toUpperCase();
        if (confirmText !== "DELETE") {
          wMsg.textContent = '탈퇴를 진행하려면 "DELETE"를 입력해주세요.';
          wMsg.classList.add("error");
          return;
        }

        const ok = confirm(
          "정말 회원 탈퇴하시겠습니까?\n탈퇴 후 30일 동안 동일 이메일로 재가입이 불가능합니다.\n30일 후 계정 정보가 완전 삭제됩니다."
        );
        if (!ok) return;

        wSubmit.disabled = true;
        wMsg.textContent = "처리 중…";
        wMsg.classList.remove("error", "success");

        try {
          const { r, data } = await apiFetch("/api/auth/withdraw", {
            method: "POST",
            body: { confirmText },
          });

          if (!r.ok) {
            // 구독 중(체험/유료/해지예약 포함) → 409 차단
            if (r.status === 409 && data?.code === "SUBSCRIPTION_ACTIVE") {
              wMsg.textContent =
                data?.message ||
                "구독 이용 중에는 탈퇴할 수 없습니다. 먼저 구독 해지를 진행해주세요.";
              wMsg.classList.add("error");
              wSubmit.disabled = false;
              return;
            }

            wMsg.textContent = data?.message || data?.error || "탈퇴 실패";
            wMsg.classList.add("error");
            wSubmit.disabled = false;
            return;
          }

          // 성공: 토큰 제거 + 이동
          localStorage.removeItem("token");
          wMsg.textContent = "회원 탈퇴가 완료되었습니다.";
          wMsg.classList.add("success");

          setTimeout(() => {
            closeWithdraw();
            location.href = "/index.html";
          }, 700);
        } catch (e) {
          wMsg.textContent = "네트워크 오류가 발생했습니다.";
          wMsg.classList.add("error");
          wSubmit.disabled = false;
        }
      });

      // false 변경 시 제거
      function applyBetaLocks(betaMode) {
        document.querySelectorAll("[data-beta-lock]").forEach((el) => {
          el.classList.toggle("beta-disabled", betaMode);
        });
      }

      async function applyPolicyBetaLock() {
        try {
          const r = await fetch(`${API_BASE_URL}/api/payments/plans`);
          const data = await r.json().catch(() => ({}));
          const betaMode = Boolean(data?.betaMode);
          applyBetaLocks(betaMode);
        } catch (e) {
          // 네트워크 실패 시: 잠금 스킵 (원하면 true로 기본 잠금도 가능)
          // applyBetaLocks(true);
        }
      }

      document.addEventListener("DOMContentLoaded", applyPolicyBetaLock);
      window.addEventListener("auth:changed", applyPolicyBetaLock); // 여기까지 제거
    </script>
  </body>
</html>
