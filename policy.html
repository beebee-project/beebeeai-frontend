<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeeBee AI - 약관</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="icon" type="image/png" sizes="32x21" href="/image/tabLogo.png" />
  </head>

  <body>
    <!-- ✅ 헤더(기존 프로젝트 구조에 맞춰 유지/최소화) -->
    <header class="header">
      <div class="header-inner">
        <a
          class="header-logo-container"
          href="index.html"
          style="
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
          "
        >
          <img
            src="image/Logo.png"
            alt="BeeBeeAI Logo"
            style="width: 26px; height: 26px"
          />
          <span
            class="logo-text"
            style="font-size: 22px; font-weight: 900; color: #fff"
            >BeeBee AI</span
          >
        </a>
        <nav class="header-nav">
          <a href="guide.html" class="nav-item">가이드</a>
          <a href="policy.html" class="nav-item">약관</a>
          <a href="price.html" class="nav-item">구독</a>
          <a href="#" id="logoutBtn" class="nav-item">로그아웃</a>
        </nav>
      </div>
    </header>

    <main
      class="container"
      style="padding: 26px 18px; max-width: 980px; margin: 0 auto"
    >
      <h1 style="color: #fff; font-size: 28px; margin: 0 0 10px 0">
        이용약관 / 정책
      </h1>
      <p style="color: rgba(255, 255, 255, 0.7); margin: 0 0 18px 0">
        구독 해지 및 회원 탈퇴는 아래에서 진행할 수 있어요.
      </p>

      <div class="policy-actions">
        <!-- ✅ 구독 해지: 비밀번호 없이 진행 -->
        <button class="link-btn" id="openCancelModal">구독 해지</button>

        <!-- ✅ 회원 탈퇴: 로그인 방식 상관 없이 DELETE 입력 -->
        <button class="link-btn" id="openWithdrawModal">회원 탈퇴</button>
      </div>

      <div class="hint">
        • 구독 해지: “확인”을 누르면 다음 결제일부터 자동 결제가 중단됩니다(이미
        결제된 기간은 만료일까지 이용 가능).<br />
        • 회원 탈퇴: 복구가 어렵습니다. 필요 데이터는 먼저 저장해주세요.
      </div>

      <hr class="hr" />

      <!-- (선택) 여기에 정책/약관 본문을 이어서 배치 -->
      <section style="color: rgba(255, 255, 255, 0.75); line-height: 1.7">
        <h2 style="color: #fff; font-size: 18px; margin: 0 0 10px 0">
          환불/해지 안내
        </h2>
        <ul style="margin: 0; padding-left: 18px">
          <li>구독 해지 시 다음 결제일부터 자동 결제가 중단됩니다.</li>
          <li>이미 결제된 기간은 이용 만료일까지 사용 가능합니다.</li>
          <li>환불은 별도 정책에 따릅니다.</li>
        </ul>
      </section>
    </main>

    <!-- =======================
         ✅ 구독 해지 모달
         ======================= -->
    <div
      id="cancelModalBackdrop"
      class="modal-backdrop hidden"
      aria-hidden="true"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="cancelModalTitle"
      >
        <h3 class="modal-title" id="cancelModalTitle">구독 해지</h3>
        <p class="modal-desc">
          구독을 해지하면 <b>다음 결제일부터 자동 결제가 중단</b>됩니다.<br />
          이미 결제된 기간은 <b>만료일까지 이용 가능</b>하며, 환불은 별도 정책에
          따릅니다.
        </p>

        <div class="modal-actions">
          <button class="btn btn-secondary" id="cancelCloseBtn">취소</button>
          <button class="btn btn-danger" id="cancelConfirmBtn">해지하기</button>
        </div>

        <div id="cancelMsg" class="modal-message"></div>
      </div>
    </div>

    <!-- =======================
         ✅ 회원 탈퇴 모달
         ======================= -->
    <div
      id="withdrawModalBackdrop"
      class="modal-backdrop hidden"
      aria-hidden="true"
    >
      <div
        class="modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="withdrawModalTitle"
      >
        <h3 class="modal-title" id="withdrawModalTitle">회원 탈퇴</h3>
        <p class="modal-desc">
          회원 탈퇴 시 즉시 이용이 종료되며, 계정 복구가 어렵습니다.<br />
          탈퇴 전 필요한 데이터가 있다면 먼저 저장해주세요.
        </p>

        <label class="modal-label" for="withdrawConfirmInput"
          >확인 문구 입력</label
        >
        <input
          id="withdrawConfirmInput"
          class="modal-input"
          type="text"
          placeholder="DELETE 를 입력하세요"
          autocomplete="off"
        />

        <div class="hint" style="margin-top: 10px">
          회원 탈퇴를 진행하려면 <b>DELETE</b>를 입력해주세요.
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" id="withdrawCloseBtn">취소</button>
          <button class="btn btn-danger" id="withdrawConfirmBtn">
            탈퇴하기
          </button>
        </div>

        <div id="withdrawMsg" class="modal-message"></div>
      </div>
    </div>

    <script>
      /**
       * ✅ policy.html 정리본
       * - 구독 해지: 비밀번호 없이 confirm → /api/payments/subscription/cancel
       * - 회원 탈퇴: 모든 로그인 방식 공통 "DELETE" 입력 → /api/auth/withdraw (confirmText)
       * - 메시지: alert 대신 모달 하단에 고정 출력
       * - API 호출: API_BASE로 통일
       */

      // =========================
      // ✅ 설정
      // =========================
      const API_BASE = "https://beebeeai-backend-production.up.railway.app";

      // =========================
      // ✅ 공통 유틸
      // =========================
      const $ = (id) => document.getElementById(id);

      const getToken = () => localStorage.getItem("token");

      const setMsg = (el, text, type) => {
        el.classList.remove("error", "success");
        if (type) el.classList.add(type);
        el.textContent = text || "";
      };

      const fmtKST = (d) =>
        d
          ? new Date(d).toLocaleString("ko-KR", { timeZone: "Asia/Seoul" })
          : null;

      const apiFetch = async (path, { method = "GET", body } = {}) => {
        const token = getToken();
        const res = await fetch(`${API_BASE}${path}`, {
          method,
          headers: {
            "content-type": "application/json",
            ...(token ? { Authorization: `Bearer ${token}` } : {}),
          },
          body: body ? JSON.stringify(body) : undefined,
          credentials: "include",
        });

        const data = await res.json().catch(() => ({}));
        return { res, data };
      };

      const openModal = (backdropEl) => {
        backdropEl.classList.remove("hidden");
        backdropEl.setAttribute("aria-hidden", "false");
      };

      const closeModal = (backdropEl) => {
        backdropEl.classList.add("hidden");
        backdropEl.setAttribute("aria-hidden", "true");
      };

      // ESC로 닫기
      window.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        const c = $("cancelModalBackdrop");
        const w = $("withdrawModalBackdrop");
        if (c && !c.classList.contains("hidden")) closeModal(c);
        if (w && !w.classList.contains("hidden")) closeModal(w);
      });

      // =========================
      // ✅ 로그아웃
      // =========================
      $("logoutBtn")?.addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("token");
        location.href = "/index.html";
      });

      // =========================
      // ✅ 구독 해지 모달 로직
      // =========================
      const cancelBackdrop = $("cancelModalBackdrop");
      const cancelMsg = $("cancelMsg");
      const cancelBtnOpen = $("openCancelModal");
      const cancelBtnClose = $("cancelCloseBtn");
      const cancelBtnConfirm = $("cancelConfirmBtn");

      cancelBtnOpen?.addEventListener("click", (e) => {
        e.preventDefault();
        setMsg(cancelMsg, "", null);
        openModal(cancelBackdrop);
      });

      cancelBtnClose?.addEventListener("click", () =>
        closeModal(cancelBackdrop)
      );
      cancelBackdrop?.addEventListener("click", (e) => {
        if (e.target === cancelBackdrop) closeModal(cancelBackdrop);
      });

      cancelBtnConfirm?.addEventListener("click", async () => {
        const ok = confirm(
          "정말 구독을 해지하시겠습니까?\n해지 후 다음 결제일부터 자동 결제가 중단됩니다."
        );
        if (!ok) return;

        cancelBtnConfirm.disabled = true;
        setMsg(cancelMsg, "처리 중…", null);

        try {
          const { res, data } = await apiFetch(
            "/api/payments/subscription/cancel",
            { method: "POST", body: {} }
          );

          if (!res.ok) {
            setMsg(
              cancelMsg,
              data?.message || data?.error || "해지 처리에 실패했습니다.",
              "error"
            );
            cancelBtnConfirm.disabled = false;
            return;
          }

          // ✅ code 기반 분류(이미 해지됨/이미 접수됨/체험 해지/정상 접수)
          if (data.code === "ALREADY_CANCELED") {
            setMsg(cancelMsg, "이미 구독 해지가 완료된 상태입니다.", "success");
          } else if (data.code === "ALREADY_CANCELED_PENDING") {
            const exp = fmtKST(data.expiresAt);
            setMsg(
              cancelMsg,
              exp
                ? `이미 구독 해지가 접수되었습니다. 이용 만료일(${exp})까지 사용 가능합니다.`
                : "이미 구독 해지가 접수되었습니다. 이용 만료일까지 사용 가능합니다.",
              "success"
            );
          } else if (data.code === "CANCELED_TRIAL") {
            const exp = fmtKST(data.expiresAt);
            setMsg(
              cancelMsg,
              exp
                ? `무료 체험 해지가 완료되었습니다. 체험 종료일(${exp})까지 이용 가능합니다.`
                : "무료 체험 해지가 완료되었습니다. 체험 종료일까지 이용 가능합니다.",
              "success"
            );
          } else {
            const exp = fmtKST(data.expiresAt);
            setMsg(
              cancelMsg,
              exp
                ? `구독 해지가 접수되었습니다. 이용 만료일(${exp})까지 사용 가능합니다.`
                : "구독 해지가 접수되었습니다. 이용 만료일까지 사용 가능합니다.",
              "success"
            );
          }

          cancelBtnConfirm.disabled = false;
        } catch (e) {
          setMsg(cancelMsg, "네트워크 오류가 발생했습니다.", "error");
          cancelBtnConfirm.disabled = false;
        }
      });

      // =========================
      // ✅ 회원 탈퇴 모달 로직
      // =========================
      const withdrawBackdrop = $("withdrawModalBackdrop");
      const withdrawMsg = $("withdrawMsg");
      const withdrawBtnOpen = $("openWithdrawModal");
      const withdrawBtnClose = $("withdrawCloseBtn");
      const withdrawBtnConfirm = $("withdrawConfirmBtn");
      const withdrawInput = $("withdrawConfirmInput");

      withdrawBtnOpen?.addEventListener("click", (e) => {
        e.preventDefault();
        if (withdrawInput) withdrawInput.value = "";
        setMsg(withdrawMsg, "", null);
        openModal(withdrawBackdrop);
        setTimeout(() => withdrawInput?.focus(), 50);
      });

      withdrawBtnClose?.addEventListener("click", () =>
        closeModal(withdrawBackdrop)
      );
      withdrawBackdrop?.addEventListener("click", (e) => {
        if (e.target === withdrawBackdrop) closeModal(withdrawBackdrop);
      });

      withdrawBtnConfirm?.addEventListener("click", async () => {
        const confirmText = String(withdrawInput?.value || "")
          .trim()
          .toUpperCase();
        if (confirmText !== "DELETE") {
          setMsg(
            withdrawMsg,
            '탈퇴를 진행하려면 "DELETE"를 입력해주세요.',
            "error"
          );
          return;
        }

        const ok = confirm(
          "정말 회원 탈퇴하시겠습니까?\n탈퇴 후 계정 복구가 어렵습니다."
        );
        if (!ok) return;

        withdrawBtnConfirm.disabled = true;
        setMsg(withdrawMsg, "처리 중…", null);

        try {
          const { res, data } = await apiFetch("/api/auth/withdraw", {
            method: "POST",
            body: { confirmText },
          });

          if (!res.ok) {
            // ✅ 구독/체험/해지예약 중이면 409 + SUBSCRIPTION_ACTIVE
            if (res.status === 409 && data?.code === "SUBSCRIPTION_ACTIVE") {
              setMsg(
                withdrawMsg,
                data?.message || "구독 이용 중에는 탈퇴할 수 없습니다.",
                "error"
              );
              withdrawBtnConfirm.disabled = false;
              return;
            }

            setMsg(
              withdrawMsg,
              data?.message || data?.error || "탈퇴 처리에 실패했습니다.",
              "error"
            );
            withdrawBtnConfirm.disabled = false;
            return;
          }

          // ✅ 성공: 토큰 제거 후 홈 이동
          localStorage.removeItem("token");
          setMsg(withdrawMsg, "회원 탈퇴가 완료되었습니다.", "success");
          setTimeout(() => (location.href = "/index.html"), 800);
        } catch (e) {
          setMsg(withdrawMsg, "네트워크 오류가 발생했습니다.", "error");
          withdrawBtnConfirm.disabled = false;
        }
      });
    </script>
  </body>
</html>
