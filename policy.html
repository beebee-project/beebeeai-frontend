<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeeBee AI - 약관</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="icon" type="image/png" sizes="32x21" href="/image/tabLogo.png" />
  </head>

  <body>
    <!-- 헤더 영역 -->
    <div class="header-group">
      <a href="index.html">
        <div class="header-logo-container">
          <div class="logo-image">
            <img src="image/Logo.png" alt="BeeBeeAI Logo" />
          </div>
          <div class="logo-text">BeeBee AI</div>
        </div>
      </a>
    </div>

    <!-- 이용 약관 -->
    <section class="policy-hero">
      <h1>약관 및 정책</h1>
      <p>BeeBee AI 서비스 이용에 필요한 모든 정책을 안내드립니다.</p>
    </section>
    <main class="policy-container">
      <!-- ======================= -->
      <!-- 1. 이용약관 -->
      <!-- ======================= -->

      <section class="policy-section">
        <h2>1. 이용약관</h2>
        <p>
          본 약관은 BeeBee AI(이하 “회사”)가 제공하는 자동 수식 생성 및 매크로
          생성 서비스(이하 “서비스”)의 이용조건과 운영에 관한 사항을 규정합니다.
        </p>

        <h3>1.1 서비스 제공 내용</h3>
        <ul>
          <li>엑셀/구글시트에 입력되는 수식 자동 생성 기능 제공</li>
          <li>Office Script/Google Apps Script 자동 생성 기능 제공</li>
          <li>회원 전용 기능 및 업로드 파일 기반 고급 생성 기능 제공</li>
          <li>향후 제공될 추가 기능 및 업데이트 제공</li>
        </ul>

        <h3>1.2 회원 계정</h3>
        <ul>
          <li>회원은 실제 사용 가능한 이메일 계정을 사용해야 합니다.</li>
          <li>
            타인의 이메일을 도용하는 경우 서비스 이용이 제한될 수 있습니다.
          </li>
          <li>회원은 자신의 계정을 안전하게 관리할 책임이 있습니다.</li>
        </ul>

        <h3>1.3 서비스 이용 제한</h3>
        <ul>
          <li>
            비정상적 사용(대량 자동 요청, 시스템 공격 등) 발생 시 사전 통보 없이
            이용을 제한할 수 있습니다.
          </li>
          <li>
            불법적 데이터 생성, 저작권 침해 등 위반 행위 발견 시 계정이 정지될
            수 있습니다.
          </li>
        </ul>
      </section>

      <!-- ======================= -->
      <!-- 2. 개인정보 처리방침 (옵션) -->
      <!-- ======================= -->

      <section class="policy-section">
        <h2>2. 개인정보 처리방침</h2>

        <p>
          BeeBee AI는 회원 가입 및 서비스 제공에 필요한 최소한의 개인정보만을
          수집합니다.
        </p>

        <h3>2.1 수집 항목</h3>
        <ul>
          <li>이메일 주소 (계정 생성 및 로그인)</li>
          <li>비밀번호(암호화 저장)</li>
          <li>사용 로그(기능 사용 횟수, 업로드 파일 수 등)</li>
        </ul>

        <h3>2.2 개인정보 보관 및 파기</h3>
        <ul>
          <li>서비스 제공 기간 동안에만 데이터를 보관합니다.</li>
          <li>
            <a href="#" id="open-withdraw-modal">회원 탈퇴</a>시 모든 개인정보는
            즉시 삭제됩니다.
          </li>
        </ul>

        <h3>2.3 제3자 제공 여부</h3>
        <p>
          BeeBee AI는 법령에 따른 요청 외에는 개인정보를 제3자에게 제공하지
          않습니다.
        </p>
      </section>

      <!-- ======================= -->
      <!-- 3. 환불정책 (토스 제출 필수 항목) -->
      <!-- ======================= -->

      <section class="policy-section">
        <h2>3. 환불정책</h2>

        <h3>3.1 정기구독 환불</h3>
        <ul>
          <li>
            결제 후 서비스 미사용 시 결제일 기준 7일 이내 전액 환불 가능합니다.
          </li>
          <li>
            서비스 사용(수식 생성, 매크로 생성 등)이 1회라도 발생한 경우 해당
            이용월은 환불이 어렵습니다.
          </li>
        </ul>

        <h3>3.2 정기결제 해지</h3>
        <ul>
          <li>
            해지는 다음 결제일 전까지 요청하면 다음 달부터 결제가 중단됩니다.
          </li>
          <li>결제 후 당월은 부분 환불되지 않습니다.</li>
        </ul>

        <h3>3.3 서비스 장애 시 보상</h3>
        <ul>
          <li>
            24시간 이상 전면 서비스 장애 발생 시 이용 기간 연장 또는 부분 환불이
            제공됩니다.
          </li>
        </ul>
      </section>

      <!-- ======================= -->
      <!-- 4. 구독정책 / 요금정책 -->
      <!-- ======================= -->

      <section class="policy-section">
        <h2>4. 구독정책</h2>
        <ul>
          <li>월 구독료: 4,900원</li>
          <li>결제 방식: 토스페이먼츠 정기구독</li>
          <li>
            <a href="#" id="open-cancel-modal">구독 해지</a>는 언제든지 신청
            가능합니다.
          </li>
          <li>
            이용자는 구독 기간 동안 모든 일반 기능을 자유롭게 이용할 수
            있습니다.
          </li>
        </ul>
      </section>
    </main>

    <!-- footer -->
    <footer class="site-footer">
      <div class="footer-inner">
        <div class="footer-company">
          <strong class="footer-logo">BeeBee AI</strong>
          <span>상호명: 비비에이아이</span>
          <span>대표자명: 김상준</span>
          <span>사업자등록번호: 354-46-01224</span>
          <span>통신판매업 신고번호: 2025-대구서구-0488</span>
        </div>

        <div class="footer-meta">
          <span>사업장 주소: 대구광역시 서구 평리로 72길 16-1, 501호</span>
          <span>번호: 010-5161-3072</span>
          <span>이메일: rlatkdwns011@naver.com</span>
          <span>서비스명: BeeBee AI 수식/매크로 자동 생성 플랫폼</span>
        </div>
      </div>

      <p class="footer-copy">© 2025 BeeBee AI. All rights reserved.</p>
    </footer>
    <script src="index.js"></script>

    <div id="cancelModal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop" id="cancelModalBackdrop"></div>

      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="cancelModalTitle"
      >
        <h3 id="cancelModalTitle">구독 해지</h3>

        <p class="modal-desc">
          구독을 해지하면 <b>다음 결제일부터 자동 결제가 중단</b>됩니다.<br />
          이미 결제된 기간은 만료일까지 이용 가능하며, 환불은 별도 정책에
          따릅니다.
        </p>

        <label class="modal-label" for="cancelPassword">비밀번호 확인</label>
        <input
          id="cancelPassword"
          type="password"
          placeholder="비밀번호를 입력하세요"
          autocomplete="current-password"
        />

        <div class="modal-actions">
          <button id="cancelModalClose" class="btn-secondary">취소</button>
          <button id="cancelModalSubmit" class="btn-danger">해지하기</button>
        </div>

        <p id="cancelModalMsg" class="modal-msg"></p>
      </div>
    </div>

    <div id="withdrawModal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop" id="withdrawModalBackdrop"></div>

      <div
        class="modal-card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="withdrawModalTitle"
      >
        <h3 id="withdrawModalTitle">회원 탈퇴</h3>

        <p class="modal-desc">
          회원 탈퇴 시 <b>즉시 이용이 종료</b>되며, 계정 복구가 어렵습니다.<br />
          탈퇴 전 필요한 데이터가 있다면 먼저 저장해주세요.
        </p>

        <label class="modal-label" for="withdrawPassword">비밀번호 확인</label>
        <input
          id="withdrawPassword"
          type="password"
          placeholder="비밀번호를 입력하세요"
          autocomplete="current-password"
        />

        <div class="modal-actions">
          <button id="withdrawModalClose" class="btn-secondary">취소</button>
          <button id="withdrawModalSubmit" class="btn-danger">탈퇴하기</button>
        </div>

        <p id="withdrawModalMsg" class="modal-msg"></p>
      </div>
    </div>
    <script>
      const API_BASE = "https://beebeeai-backend-production.up.railway.app";
      const modal = document.getElementById("cancelModal");
      const openBtn = document.getElementById("open-cancel-modal");
      const closeBtn = document.getElementById("cancelModalClose");
      const backdrop = document.getElementById("cancelModalBackdrop");
      const submitBtn = document.getElementById("cancelModalSubmit");
      const pwInput = document.getElementById("cancelPassword");
      const msg = document.getElementById("cancelModalMsg");

      function openModal() {
        msg.textContent = "";
        pwInput.value = "";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
        setTimeout(() => pwInput.focus(), 50);
      }
      function closeModal() {
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
      }

      openBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        openModal();
      });
      closeBtn?.addEventListener("click", closeModal);
      backdrop?.addEventListener("click", closeModal);
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeModal();
      });

      submitBtn?.addEventListener("click", async () => {
        const password = pwInput.value.trim();
        if (!password) {
          msg.textContent = "비밀번호를 입력해주세요.";
          return;
        }

        submitBtn.disabled = true;
        msg.textContent = "처리 중…";

        try {
          const token = localStorage.getItem("token");
          const r = await fetch(
            `${API_BASE}/api/payments/subscription/cancel`,
            {
              method: "POST",
              headers: {
                "content-type": "application/json",
                ...(token ? { Authorization: `Bearer ${token}` } : {}),
              },
              body: JSON.stringify({ password }),
              credentials: "include",
            }
          );

          const data = await r.json().catch(() => ({}));

          if (!r.ok) {
            msg.textContent = data?.error || "해지 처리에 실패했습니다.";
            submitBtn.disabled = false;
            return;
          }

          msg.textContent =
            "구독 해지가 완료되었습니다. 다음 결제일부터 결제가 중단됩니다.";
          // 원하면 여기서 배지/표시 갱신 이벤트 쏴도 됨
          // window.dispatchEvent(new Event("auth:changed"));

          setTimeout(() => {
            closeModal();
            location.reload();
          }, 900);
        } catch (e) {
          msg.textContent = "네트워크 오류가 발생했습니다.";
          submitBtn.disabled = false;
        }
      });

      const wModal = document.getElementById("withdrawModal");
      const wOpenBtn = document.getElementById("open-withdraw-modal");
      const wCloseBtn = document.getElementById("withdrawModalClose");
      const wBackdrop = document.getElementById("withdrawModalBackdrop");
      const wSubmitBtn = document.getElementById("withdrawModalSubmit");
      const wPwInput = document.getElementById("withdrawPassword");
      const wMsg = document.getElementById("withdrawModalMsg");

      function openWithdraw() {
        wMsg.textContent = "";
        wPwInput.value = "";
        wModal.classList.remove("hidden");
        wModal.setAttribute("aria-hidden", "false");
        setTimeout(() => wPwInput.focus(), 50);
      }

      function closeWithdraw() {
        wModal.classList.add("hidden");
        wModal.setAttribute("aria-hidden", "true");
      }

      wOpenBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        openWithdraw();
      });
      wCloseBtn?.addEventListener("click", closeWithdraw);
      wBackdrop?.addEventListener("click", closeWithdraw);
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !wModal.classList.contains("hidden"))
          closeWithdraw();
      });

      wSubmitBtn?.addEventListener("click", async () => {
        const password = wPwInput.value.trim();
        if (!password) {
          wMsg.textContent = "비밀번호를 입력해주세요.";
          return;
        }

        wSubmitBtn.disabled = true;
        wMsg.textContent = "처리 중…";

        try {
          // ⚠️ 인증 방식에 따라 아래 중 하나를 사용:
          // (A) 쿠키 인증이면 credentials: "include"만으로 OK
          // (B) JWT 토큰이면 Authorization 헤더를 추가해야 함
          const token = localStorage.getItem("token"); // 프로젝트에서 토큰 저장 키가 다르면 맞춰줘

          const r = await fetch(`${API_BASE}/api/auth/withdraw`, {
            method: "POST",
            headers: {
              "content-type": "application/json",
              ...(token ? { Authorization: `Bearer ${token}` } : {}),
            },
            body: JSON.stringify({ password }),
            credentials: "include",
          });

          const data = await r.json().catch(() => ({}));

          if (!r.ok) {
            if (r.status === 409 && data?.code === "SUBSCRIPTION_ACTIVE") {
              wMsg.textContent = data?.message || "먼저 구독을 해지해주세요.";
              // 원하면 구독 해지 모달 자동 오픈
              setTimeout(() => {
                closeWithdraw();
                openModal(); // 구독 해지 모달
              }, 800);
              wSubmitBtn.disabled = false;
              return;
            }
            wMsg.textContent =
              data?.message || data?.error || "탈퇴 처리에 실패했습니다.";
            wSubmitBtn.disabled = false;
            return;
          }

          // ✅ 탈퇴 성공: 로컬 토큰 제거 + 홈으로 이동
          localStorage.removeItem("token");
          wMsg.textContent = "회원 탈퇴가 완료되었습니다.";
          setTimeout(() => {
            closeWithdraw();
            location.href = "/";
          }, 700);
        } catch (e) {
          wMsg.textContent = "네트워크 오류가 발생했습니다.";
          wSubmitBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
